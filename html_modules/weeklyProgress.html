<head>
    <style type="text/css">

        #three {
            display: flex;
            justify-content: space-around;
        }

        #pastWeekHeader {
            font-style: italic;
            font-size: 150%;
        }
        
        #footer {
            font-style: italic;
            font-weight: bold;
            font-size: 100%;
        }
        
        #overallProgressHeader {
            font-style: italic;
            font-size: 150%;
        }

        .titel {
            font-style: italic;
            text-align: center;
        }

        .text {
            font-style: italic;
            text-align: center;
            font-weight: bold;
            font-size: 300%;
            color: #C84B4B;
        }
    </style>

    <script>

        var SERVER_URL = "https://guarded-mesa-27479.herokuapp.com";

        function loadScript(url, callback)
        {
            // Adding the script tag to the head as suggested before
            var head = document.head;
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;

            // Then bind the event to the callback function.
            // There are several events for cross browser compatibility.
            script.onreadystatechange = callback;
            script.onload = callback;

            // Fire the loading
            head.appendChild(script);
        }

        var generateNumbers = function() {

            var userId = analytics.user()._getId();

            var url = window.location.href;
            var split = url.split("/");
            var courseId = split[4].split(":")[1];

            // Get the week number based on the current date and the start date of each week recorded in SRLUICourseInfo.js
            var weekNumber;

            var currentDate = new Date();
            var courseStartDate; 

            for(var key in courseDates) 
            {
                var tempDate = new Date(key);

                if (currentDate > tempDate )
                {
                    weekNumber = courseDates[key];
                    courseStartDate = new Date(key);
                }
            }

            // Set date string for past week      
            var startString = convertDateToString(courseStartDate); 
            var endString = convertDateToString(currentDate);
            var dateString = "In the past week of the course (" + startString + " - " + endString + ") you have:";
            document.getElementById("pastWeekHeader").innerHTML = dateString; 

            // Send GET request for to get activity for specific user/course/week number. 
            var settings = {
                "async": true,
                "crossDomain": true,
                "url": SERVER_URL + "/api/events/week",
                "method": "GET",
                "data": {
                    "userId": userId,
                    "courseId": courseId, 
                    "weekNumber": weekNumber
                }
            };

            $.ajax(settings).done(function (response) {
                var weekResult = response.data; 

                // Set past week results
                document.getElementById("videosWatched").innerHTML = weekResult.videosWatched; 
                document.getElementById("questionsAnswered").innerHTML = weekResult.questionsAnswered; 
                document.getElementById("postsViewed").innerHTML = weekResult.postsViewed; 
                document.getElementById("postsCreated").innerHTML = weekResult.postsCreated; 
            });          
        }
        
        function getKeyByValue(object, value) {
            return Object.keys(object).find(key => object[key] === value);
        }

        function convertDateToString(d)
        {
            var dd = d.getDate(); 
            var mm = d.getMonth()+1; 
            var yyyy = d.getFullYear();

            if(dd<10) 
            {
                dd='0'+dd;
            } 

            if(mm<10) 
            {
                mm='0'+mm;
            } 

            return mm +'/'+ dd +'/'+ yyyy;
        }

        // Sort events by week number
        function sortByWeekNumber(record1, record2)
        {
            if (record1.weekNumber > record2.weekNumber)
            {
                return 1; 
            }

            if (record1.weekNumber < record2.weekNumber)
            {
                return -1; 
            }

            return 0; 
        } 

        /**** LOAD THE CHART ***/ 
        var generateLineChart = function () {
            var userId = analytics.user()._getId();

            var url = window.location.href;
            var split = url.split("/");
            var courseId = split[4].split(":")[1];
            
            // Send GET request for to get activity for specific user/course. 
            var settings = {
                "async": true,
                "crossDomain": true,
                "url": SERVER_URL + "/api/events",
                "method": "GET",
                "data": {
                    "userId": userId,
                    "courseId": courseId 
                }
            };

            $.ajax(settings).done(function (response) {
                var aggVideosWatched = []; 
                var aggQuestionsAnswered = []; 
                var aggPostsCreated = []; 
                var aggPostsViewed = []; 
                
                var result = response.data; 
                console.log(result); 
                result.sort(sortByWeekNumber);

                // Set data points for line chart
                for (var i = 0; i < result.length; i++)
                {
                    // Get the actual start date of the week and attach it to the chart label
                    var startDate = getKeyByValue(courseDates, result[i].weekNumber); 

                    var dates = startDate.split("-");

                    var weekString = "Week " + result[i].weekNumber + " (" + dates[1] + "/" + dates[2] + ")"; 
                    
                    aggVideosWatched.push({label: weekString, y: result[i].videosWatched});
                    aggQuestionsAnswered.push({label: weekString, y: result[i].questionsAnswered});
                    aggPostsCreated.push({label: weekString, y: result[i].postsViewed});
                    aggPostsViewed.push({label: weekString, y: result[i].postsCreated});
                }


                var chart = new CanvasJS.Chart("chartContainer", {
                    theme:"light2",
                    animationEnabled: true,
                    title:{
                        text: "Class Progress"
                    },
                    axisY :{
                        includeZero: true,
                        title: "Number of Actions",
                        suffix: ""
                    },
                    toolTip: {
                        shared: "true"
                    },
                    legend:{
                        cursor:"pointer",
                        itemclick : toggleDataSeries
                    },
                    data: [{
                        type: "spline", 
                        showInLegend: true,
                        yValueFormatString: "",
                        name: "Videos Watched",
                        dataPoints: aggVideosWatched
                    },
                    {
                        type: "spline", 
                        showInLegend: true,
                        yValueFormatString: "",
                        name: "Posts Viewed",
                        dataPoints: aggPostsViewed
                    },
                    {
                        type: "spline", 
                        showInLegend: true,
                        yValueFormatString: "",
                        name: "Posts Created",
                        dataPoints: aggPostsCreated
                    },
                    {
                        type: "spline", 
                        showInLegend: true,
                        yValueFormatString: "",
                        name: "Questions Answered",
                        dataPoints: aggQuestionsAnswered
                    }]
                });
                chart.render();

                
            });          

            function toggleDataSeries(e) {
                if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible ){
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                chart.render();
            }

        };
    </script>


</head>

<body>
    <div id="startPlan">

      <p id="pastWeekHeader"></p>

      <br>

      <div id="three">
        <div id="col1">
            <div id="videosWatched" class="text"></div>
            <div class="vidFeedback titel">Videos Watched</div>
        </div>
        <div id="col2">
            <div id="questionsAnswered" class="text"></div>
            <div class="quizFeedback titel">Problems Tried</div>
        </div>
        <div id="col3">
            <div id="postsCreated" class="text"></div>
            <div class="timeFeedback titel">Times Posted</div>
        </div>
        <div id="col4">
            <div id="postsViewed" class="text"></div>
            <div class="timeFeedback titel">Posts Viewed</div>
        </div>
    </div>

    <br>
    <br>

    <p id="overallProgressHeader">Your overall course progress:</p>

    <div id="chartContainer" style="height: 300px; width: 100%;"> 
        <script> 
            loadScript("/static/SRLUICourseInfo.js", generateNumbers);
            loadScript("https://canvasjs.com/assets/script/canvasjs.min.js", generateLineChart);
        </script>

    </div>
    
    <br>
    <br>
    <p id="footer">*Note edX course weeks start on Mondays</p>

</div>

</body>


